<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%- history_json.Titulo %></title>
    <%- include('../partials/head') %> 
    <link rel="stylesheet" type="text/css" href="/css/story.css">
</head>
<body>
    <%- include('../partials/header', {user: user}); %>
    <div class="ex_title">
        <div class="title">
            <h1 id="history_title"></h1>
        </div>
    </div>

    <div id="content">
        <div class="container" style="font-size:20px; margin-left: 10px;margin-top: -20px;"> 
            <% if(!history_json.have_liked){ %>
                <div id="like-button">üñ§</div>
            <% }else{ %>
                <div id="like-button" class="liked">‚ù§Ô∏è</div>
            <% } %>    
            &MediumSpace; <span id="likes"><%- history_json.likes %> </span>
        </div>  
        <hr>

        <p id="History"></p>
        <p id="choice">O que voc√™ escolhe?</p>
        <div id="options"></div>
        <div style="width:100%; text-align: center;">
            <button class="btn btn-outline-primary" style="margin-top: 30px; font-size: 15px;" id="return">Voltar ao in√≠cio</button>
        </div>
    </div>

    <script src="/js/script.js"></script>
    <script>
        var current_choice = 0
        var options
        var main_json
        main_json = <%- JSON.stringify(history_json) %>
        history_initialization()
        load_history()
    </script>
    <% if(user){ %>
        <script>
            var state = main_json.have_liked
    
            document.getElementById('like-button').addEventListener('click', (el) => {
                el.currentTarget.classList.toggle('liked');
                let offset = el.currentTarget.classList.value === 'liked'? 1 : 0;
                offset = main_json.have_liked ? --offset: offset;
                if(!(el.currentTarget.classList.value === 'liked')){
                    document.getElementById('like-button').innerText ='üñ§';
                    state = false
                }else{
                    document.getElementById('like-button').innerText ='‚ù§Ô∏è';
                    state = true
                }
                
                document.getElementById('likes').innerText = Number.parseInt(main_json.likes) + offset;
            });
    
            window.onbeforeunload = function(e) {
                call_like();
            }
            
            async function call_like(){
                if(state === main_json.have_liked){
                    return
                }
                result = await fetch("/like", {
                            method: "POST",
                            headers: {
                            "Content-Type": "application/json",
                            },
                            body: JSON.stringify({story_id: main_json._id, value: state}),
                        })
            }
        </script>
        <% } %>
</body>
</html>